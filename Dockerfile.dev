# Use a Python image with uv pre-installed
FROM ghcr.io/astral-sh/uv:python3.13-alpine

# This will be set by the GitHub action to the folder containing this component.
ARG FOLDER=/app

COPY --chown=1000:1000 . /app
WORKDIR ${FOLDER}

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Ensure installed tools can be executed out of the box
ENV UV_TOOL_BIN_DIR=/usr/local/bin

# Place executables in the environment at the front of the path
ENV PATH="$FOLDER/.venv/bin:$PATH"

# Install Node.js, nodemon, and supervisord for process management
USER root
RUN apk update \
    && apk add nodejs npm supervisor \
    && npm install -g nodemon

# Allow uv to use cache
RUN mkdir -p /.cache/uv && chown 1000:1000 /.cache /.cache/uv

# Create supervisor directories and set proper ownership
RUN mkdir -p /etc/supervisor/conf.d /var/log/supervisor /var/run && \
    chown -R 1000:1000 /app

# Reset the entrypoint, don't invoke `uv`
ENTRYPOINT []

EXPOSE 8000
ENV PORT=8000
ENV HOST="0.0.0.0"

# Run supervisor as root (required for /etc/supervisor access)
# The managed processes will run as user 1000 as specified in their config
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf", "-n"]
